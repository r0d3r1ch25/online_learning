apiVersion: argoproj.io/v1alpha1
kind: CronWorkflow
metadata:
  name: online-learning-cron-v0
spec:
  schedule: "*/2 * * * *"  # Every 2 minutes
  timezone: "UTC"
  workflowSpec:
    entrypoint: single-pipeline-step
    templates:
    - name: single-pipeline-step
      container:
        image: alpine/curl:latest
        command: [sh, -c]
        args:
          - |
            echo "Processing observation at $(date)"
            
            # Get observation
            OBSERVATION=$(curl -s --max-time 10 "http://ingestion-service.ml-services.svc.cluster.local:8002/next")
            if [ $? -ne 0 ]; then
              echo "No more observations available"
              exit 0
            fi
            
            ACTUAL_VALUE=$(echo "$OBSERVATION" | jq -r '.target')
            echo "Actual: $ACTUAL_VALUE"
            
            # Get features and predict_learn
            RESULT=$(echo "$OBSERVATION" | \
              jq '{series_id: "argo_cron_pipeline", value: .target}' | \
              curl -s --max-time 10 -X POST \
                -H "Content-Type: application/json" \
                --data-binary @- \
                "http://feature-service.ml-services.svc.cluster.local:8001/add" | \
              jq '{features: .features, target: .target}' | \
              curl -s --max-time 10 -X POST \
                -H "Content-Type: application/json" \
                --data-binary @- \
                "http://model-service.ml-services.svc.cluster.local:8000/predict_learn")
            
            PREDICTION=$(echo "$RESULT" | jq -r '.prediction')
            echo "Prediction: $PREDICTION"
            echo "Actual: $ACTUAL_VALUE | Prediction: $PREDICTION"
            echo "Completed at $(date)"
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "128Mi"
            cpu: "200m"